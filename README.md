# MCNC RAG Assistant - 청킹 시스템 페이지 매핑 개선 요약

## 📋 작업 개요
- **작업 내용**: 청킹 시스템의 페이지별 메타데이터 매핑 정확도 개선
- **작업 일시**: 2025-01-31
- **주요 이슈**: 각 청크에 잘못된 페이지의 테이블/이미지가 포함되는 문제 해결

## 🔧 해결한 문제들

### 1. **weakenPage 전략의 페이지 경계 처리 문제**

#### 발견된 문제
- 청크 0: "...사업을주도하고있습니다.\n01. Overview\n\n--- 페이지 5 ---" (끝)
- 문제: 5페이지 마커만 있고 실제 내용이 없는데도 5페이지 테이블/이미지가 포함됨
- RAG 관점: 사용자가 "5페이지 테이블" 검색 시 내용이 없는 청크 0이 반환되면 무의미

#### 해결책
- 페이지 마커만 있고 실제 내용이 충분하지 않으면 해당 페이지 메타데이터 제외
- 최소 50자 이상의 실제 내용이 있어야 해당 페이지로 인정

### 2. **페이지 번호 계산 오류**

#### 발견된 문제
```
청크 1: "--- 페이지 5 ---\n내용...\n--- 페이지 7 ---"
실제: 5, 6페이지 포함
오류: [1, 2, 4, 5] 페이지로 잘못 계산
```

#### 해결책
- 복잡한 문자 위치 기반 계산 제거
- 청크 텍스트에서 직접 페이지 마커를 찾아 분석
- 연속되지 않은 페이지 번호 사이의 누락된 페이지 자동 추가 (5→7이면 6 포함)

### 3. **타입 오류**
- `chunk-processor.ts`: 암시적 any 타입 오류
- `types.ts`: `total_tokens` 필드 누락

## 📝 주요 코드 변경사항

### 1. **새로운 페이지 추출 메서드** (chunker.ts)
```typescript
private getPagesFromChunkContent(content: string): number[] {
  // 청크 내용에서 직접 페이지 마커 찾기
  // 각 마커 이후 최소 50자 이상의 내용 확인
  // 중간에 누락된 페이지 번호 자동 추가
}
```

### 2. **페이지 경계 추출 개선**
```typescript
private extractPageBoundaries(content: string) {
  // 모든 페이지 마커 수집
  // 누락된 페이지 번호 감지 및 보간
  // 각 페이지의 실제 내용 시작/끝 위치 정확히 계산
}
```

### 3. **메타데이터 위치 정보 확장** (types.ts)
```typescript
position: {
  pages?: number[];  // 청크가 포함하는 모든 페이지 번호들
  page?: number;     // 단일 페이지인 경우
}
```

## 🎯 개선 결과

### 변경 전
- 청크에 잘못된 페이지의 메타데이터 포함
- 페이지 마커만 있어도 해당 페이지로 인식
- 중간 페이지 누락 (5→7 사이의 6페이지)

### 변경 후
- 각 청크는 실제 내용이 있는 페이지의 메타데이터만 포함
- 최소 내용 길이 검증으로 정확도 향상
- 누락된 페이지 번호 자동 보간

## 📊 검증 방법

### 실행
```bash
rm -rf data/processed/chunks
npm run chunk
```

### 로그 확인
```
Chunk 0:
  Pages: [1, 2, 3, 4]  // 5 제외됨
  Page markers found: --- 페이지 5 ---

Chunk 1:
  Pages: [5, 6]  // 정확히 계산됨
  Page markers found: --- 페이지 5 ---, --- 페이지 7 ---
```

### 메타데이터 검증
- 각 청크의 enrichments에 해당 페이지의 테이블/이미지만 포함
- 누락된 구조화 데이터 자동 재배치 및 로그 출력

## 🔍 핵심 개선사항

1. **검색 정확도 향상**
   - 테이블/이미지와 관련 텍스트가 같은 청크에 위치
   - 잘못된 페이지 메타데이터로 인한 검색 노이즈 제거

2. **페이지 계산 정확도**
   - 청크 텍스트 기반 직접 분석
   - 누락된 페이지 번호 자동 감지 및 추가

3. **디버깅 정보 강화**
   - 각 청크의 페이지 범위 상세 로그
   - 누락된 구조화 데이터 재배치 과정 추적

## 📅 작업 완료
2025-01-31 - 페이지별 메타데이터 매핑 정확도 개선 완료

## 🚀 다음 단계
- 임베딩 시스템 구현
- 청킹 품질 검증 자동화
- 다양한 문서 형식에 대한 테스트